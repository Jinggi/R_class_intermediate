library(dplyr)
library(ggplot2)

library(readxl)
df <- read_excel("office_data.xlsx")

head(df)
str(df)
summary(df)

### ?Ð¼?????

lm(df$price ~ df$rent)
lm(price ~ rent, data=df)
attach(df)
fit <- lm(price ~ rent)
detach(df)

(fit <- lm(price ~ ., df))
(fit <- lm(price ~ rent + gfa, df))
(fit <- lm(price ~ rent + log(rent), df))   #log?? ?×´??? ???? ????
(fit <- lm(price ~ rent + gfa + I(gfa^2), df))   #log ???? ????Àº I()
(fit <- lm(price ~ rent + poly(gfa, 2, raw=T), df))   #??????À» ?????Ï°?

(fit <- lm(price ~ rent + gfa + 0, df))
(fit <- lm(price ~ rent + gfa - 1, df))

df$region
df$region <- factor(df$region, levels=c("ETC", "CBD", "GBD", "YBD"))
df$region   #?????? ??Á¤?Ï¿?À¸?Ç·? ?Ç¾? ETC?? ???Øº???

(fit <- lm(price ~ rent + region, df))   #???Ú³? ?????? ?????? ?Úµ?À¸?? ???? Ã³??
(fit <- lm(price ~ rent + region + 0, df))   #?????? Á¦???Ï¸? ???Ìº??? ???? ????

(fit <- lm(price ~ rent + region + rent:region, df))
(fit <- lm(price ~ rent * region, df))

df %>%
  ggplot(aes(x=rent, y=price)) +
  geom_point() +
  geom_smooth(method="lm", se=F) +
  facet_wrap(~region)

(fit <- lm(price ~ rent, subset=1:30, df))
(fit <- lm(price ~ rent, subset=region=="CBD", df))



### ?Ð¼?????

# ?âº»????

summary(fit)

anova(fit)
anova(fit1, fit2)   #???? ?? ????. H0: ???? ??À½

summary(fit)$r.squared
deviance(fit)
logLik(fit)
AIC(fit)

coef(fit)
confint(fit)

resid(fit)
vcov(fit)

fitted(fit)

plot(fit)

# broom ????

library(broom)
tidy(fit)   #È¸?Í°????? ???????Á·???(tibble)À¸?? ????
augment(fit)   #???Ú·á¿¡ ???Õ°?, ????, ???????? ?? ?ß°??Ï¿? ???????Á·???(tibble)À¸?? ????
glance(fit)   #?????? ???Õµ? ???? ??Ç¥??À» ???????Á·???(tibble)À¸?? ????



### ????????

# ???íº¯?? ?Ï³??? ?????Ø¼? ????

fit <- df %>%    #df?? ???Ôµ? ???? ???íº¯???? ?Ï³??? ?????Ø¼? È¸?ÍºÐ¼? ?Ç½?
  select(-price) %>% 
  map(~lm(price ~ .x, data=df))   #map ?Ô¼??? ?? È¸?ÍºÐ¼? ?????? ????Æ®?? ????
fit

comp <- fit %>%    #?Ð¼??????? ?Ï³??? Ç¥?? ?Û¼?
  map_dfr(glance) %>%    #glance ???? ??Ç¥?? ?? ????À¸?? ?????Ï¿? ???????Á·??? ?Û¼?
  bind_cols(x=names(fit), .) %>%    #?? ?????? ?Ì¸?À» ???? ?Û¼??Ï¿? ?? ?Õ¿? ?ß°?
  select(x, r.squared, p.value) %>%    #??Á¤?????? P???? ????
  print()

comp %>%    #?ñ±³°????? ?×·??Á·? ?Û¼?
  ggplot(aes(x=reorder(x, r.squared), y=r.squared)) +
  geom_point(aes(color=p.value<=.05), size=3) +
  labs(x="", y=expression(R^{2}), color="Significant")

# ???íº¯?? ???? ?????Ø¼? ???????? ????

library(leaps)   #?????? ????
fit <- regsubsets(price ~ ., nbest=1, nvmax=6, df)  #???? 1~6??. ???????? ???????? 1??
plot(fit)   #BIC?×·???
plot(fit, scale="adjr2")   #??Á¤??Á¤?????×·???

library(MASS)   #?Ü°??? ????
fit_full <- lm(price ~ ., df)
fit_null <- lm(price ~ 1, df)

stepAIC(fit_null,   #????
        scope=list(lower=fit_null, upper=fit_full),
        trace=F)

stepAIC(fit_full,   #????
        scope=list(lower=fit_null, upper=fit_full),
        trace=F)



### È¸??????

## ?×·??Á·? ??Ã¼???? ????

(fit <- lm(price ~ rent + gfa, df))

par("mar")
par(mar=c(1, 1, 1, 1))
par(mfrow=c(2, 2))
plot(fit, pch=20)   #?ÌºÐ»ê¼º, Á¤?Ôº???, ?Ì»?Ä¡ ????
par(mfrow=c(1, 1))

library(car)
crPlots(fit)   #???íº¯?????? ?????? ????


## Á¤?Ô¼? ??Á¤

shapiro.test(resid(fit))   #Shapiro-Wilk ??Á¤

# Box-Cox ??È¯: Á¤?Ô¼?, ?ÌºÐ»ê¼º À§???Ç¾? ???Àº??? ??È¯ ?Ê¿??? ??
# y^lambda(lambda!=0) ?Ç´? log(y)(lambda=0) ???Â·? ???Àº??? ??È¯
# ??Ã¼???? lambda ??Àº log-likelihood ???? ???? - 0???? Å©?? ???î³ª?? ??À¸?? log?? ?í¸®

library(car)
boxCox(fit)


## ???ß°????? ??Á¤

vif(fit)


## ?ÌºÐ»ê¼º ??Á¤

library(lmtest)
bptest(fit)

library(car)
ncvTest(fit)   #Breusch-Pagan ??Á¤
hccm(fit)   #vcov() ???? heteroskedasticity consistent covariance matrix ????

# ?ÌºÐ»ê¿¡ ?????? È¸?ÍºÐ¼?

fit <- lm(price ~ rent + gfa, data=df, weight=w)   #?????? ???????? ?? ???? ?Ö°?

library(MASS)
fit <- rlm(price ~ rent + gfa, data=df)   #robust regression using an M estimator


## ?????? ??Á¤ = ?Ú±??????? ??Á¤

durbinWatsonTest(fit)   #1?? ?Ú±????? Durbin-Watson ??Á¤

library(forecast)
checkresiduals(fit)   #???? ?Ú±????? Breusch-Godfrey ??Á¤

# ARMA ??????: ?????? À§???Ç¾? ?????? ??È¯ ?Ê¿??? ??

library(forecast)
fit <- auto.arima(df$price,
                  xreg=model.matrix(fit)[,-1],   #???? ???Ä¿??? ?????? Á¦??
                  stepwise=F, approximation=F)
summary(fit)
checkresiduals(fit)

# Prais-Winsten

library(prais)
fit <- prais_winsten(price ~ rent + gfa, data=df)

# Cochrane-Orcutt

library(orcutt)
reg <- lm(price ~ rent + gfa, data=df)
fit <- cochrane.orcutt(reg)


## ?Ì»?Ä¡ ??Á¤

library(car)
infIndexPlot(fit)   #Cook's distance, St. resid, Bonferroni P, Hat value(Leverage) ????
influencePlot(fit)   #Cook's distance, St. resid, Hat value(Leverage) ????
outlierTest(fit)   #St. resid?? ?Ì¿? ???? Bonferroni ??Á¤ P ??Á¤

avPlots(fit)   #(y~.-x1)?? (x1~.-y)?? Resid?? ?????? Added variable plot ????



### ?????? ????

# ????: Æ¯Á¤?? x ???? ???? y?? ???Õ°? ?Ç´? ?????? ????

(fit <- lm(price ~ rent + gfa, df))

x <- data.frame(rent=1:10, gfa=101:110)   #x?? ???????Á·???À¸?? ?Û¼?
predict(fit, x, interval=c("none"))   #???????? ????
predict(fit, x, interval=c("confidence"))   #???Õ°? ?????? ?Å·Ú±???
predict(fit, x, interval=c("prediction"))   #?????? ?????? ?Å·Ú±???

# ????????: Training Data?? Test Data?? ?????? ?????? ????

library(caret)
set.seed(1234)
i <- createDataPartition(df$price, p=.8, list=F)
train <- df %>% slice(i)
test <- df %>% slice(-i)

(fit <- lm(price ~ rent + gfa, train))
(pred <- predict(fit, test))

defaultSummary(data.frame(obs=test$price, pred=pred))
#???????? ??????À» ??Ç¥?? ????
#RMSE(Root Mean Squared Error)
#Rsquared(??????, ?????? ?????????? Á¦??)
#MAE(Mean Absolute Error)

data.frame(obs=test$price, pred=pred) %>%    #??????, ?????? ?×·??Á·? ????
  ggplot(aes(x=obs, y=pred)) +
    geom_point() +
    geom_abline(intercept=0, slope=1)
